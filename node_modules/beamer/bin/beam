#!/usr/bin/env node

var colors = require('colors')

require('command-router')
.on('notfound', help)
.option({ name: 'bucket'
, alias: 'b'
, type: String
})
.option({ name: 'key'
, alias: 'k'
, type: String
})
.option({ name: 'secret'
, alias: 's'
, type: String
})
.option({ name: 'region'
, alias: 'r'
, type: String
, default: 'us-west-1'
})
.option({ name: 'dirname'
, alias: 'd'
, type: String
})
.option({ name: 'header'
, alias: 'h'
, type: Array
})
.option({ name: 'mime'
, alias: 'm'
, type: Array
})
.option({ name: 'gzip'
, alias: 'g'
, type: Boolean
, default: true
})
.command('config set :key :value', function(params, options){
  var ini = require('ini')
    , fs = require('graceful-fs')
    , config

  // TODO: validate keys
  fs.readFile('./.beam', 'utf8', function(err, data){
    if (err && err.code !== 'ENOENT') throw err

    var config = data ? ini.parse(data) : {}

    config[params.key] = params.value

    fs.writeFile('./.beam', ini.stringify(config), function(err){
      if (err) throw err
    })
  })
})
.command(':dirname', function(params, options){
  var beamer = require('../')
    , ini = require('ini')
    , fs = require('graceful-fs')

  fs.readFile('./.beam', 'utf8', function(err, data){
    if (err && err.code !== 'ENOENT') throw err

    var config = data ? ini.parse(data) : {}

    // merge CLI opts onto the config
    for (var key in options) {
      if (options[key]) config[key] = options[key]
    }

    beamer(params.dirname)
    .configure(config)
    .on('start', console.log)
    .on('error', function(err){
      console.error()
      console.error('Can\'t upload :(')
      console.error()
      console.error('  ' + err.message)
      console.error()

      process.exit(1)
    })
    .on('PUT', function(pathname){
      console.log('    âœ“'.green, ('PUT ' + pathname).grey)
    })
    .on('delete', function(){})
    .on('end', function(stats){
      console.log()
      console.log(('  ' + stats.uploaded + ' objects uploaded').green, '(x ms)'.grey)
      console.log(('  ' + stats.deleted + ' objects deleted').yellow, '(x ms)'.grey)
      console.log()
    })
  })

})
.parse(process.argv)

function help(action){
  var action = action || 'beam'
    , path = require('path')
    , fs = require('graceful-fs')
    , file = path.resolve(__dirname, '../doc/' + action + '.md')

  fs.exists(file, function(exists){
    if (! exists) file = path.resolve(__dirname, '../doc/beam.md')

    console.log() // newline before the doc output

    fs.createReadStream(file, { encoding: 'utf8' })
    .on('data', console.log)
    .on('error', function(err){ throw err })
    .on('end', function(){ process.exit(1) })
  })
}
