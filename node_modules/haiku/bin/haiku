#!/usr/bin/env node

var cli = require('command-router')
  , fs = require('graceful-fs')
  , path = require('path')
  , haiku = require('../')

cli.option({ name: 'src'
, default: process.cwd()
, type: path
})

cli.option({ name: 'port'
, default: 8080
, type: Number
})

cli.option({ name: 'host'
, default: 'localhost'
, type: String
})

cli.option({ name: 'log-level'
, default: 'warn'
, type: String
})

// # CLI routes
cli.on('notfound', help)

cli.command('build', function(){
  haiku(cli.src)
  .configure(cli.options)
  .on('error', function(err){
    // TODO: spill a meaningful error message instead of throwing
    throw err
  })
  .on('end', function(){
    var h = this
      , rimraf = require('rimraf')

    rimraf(h.opt('build-dir'), function(err){
      if (err) return h.emit(err)

      h.pages.forEach(function(page){
        // page.build(function(err, built){
        //   if (err) return h.emit('error', err)
        //   else return finish()
        // })

        page.render(function(err, out){
          if (err) return h.emit('error', err)

          var fs = require('graceful-fs')
            , mkdirp = require('mkdirp')
            , dirname = path.dirname(page.destination)

          mkdirp(dirname, function(err, made){
            if (err) return h.emit('error', err)

            fs.writeFile(page.destination, out, function(err){
              if (err) return h.emit('error', err)
              finish()
            })
          })
        })
      })

      var counter = 0

      function finish(){
        counter++

        if (counter === h.pages.length) {
          fs.exists(h.opt('public-dir'), function(exists){
            if (! exists) return

            // Copy public
            var ncp = require('ncp').ncp // ?

            ncp(h.opt('public-dir'), h.opt('build-dir'), function(err){
              if (err) return h.emit('error', err)
            })

          })
        }

      }
    })
  })
})

cli.command('server', function(params, options){
  var http = require('http')
    , st = require('st')
    , mount = st({ path: options.src + '/public'
      , url: '/'
      , passthrough: true
      , index: false
      })

  http.createServer(function(req, res){
    mount(req, res, function(){
      res.haiku = haiku(req, res, { src: options.src })
      res.haiku(req.url)
    })
  }).listen(options.port, options.host)
})


// Kick the whole thing off...
cli.parse(process.argv)

// # help(action)
//
// Display help for `action` defined in doc/cli/<action>.md then exit 1
//
//    help('build')
//
function help(action){
  var action = action || 'index'
    , file = path.join(__dirname, '..', 'doc', 'cli', action + '.md')

  // Add a newline
  console.log()

  // `cli.on('notfound', help)` makes its possible to try and look up
  // help for non-existent commands. If that is the case just show the
  // default.
  fs.exists(file, function(exists){
    if (!exists) return help()

    fs.createReadStream(file, { encoding: 'utf8' })
    .on('data', console.log)
    .on('error', function(err){ throw err })
    .on('end', function(){ process.exit(1) })
  })
}
